<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–°NISAç©ç«‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #e8f5f1;
    --card: #ffffff;
    --mint: #a8d5ba;
    --green: #4a8c6f;
    --text: #44504c;
    --muted: #8fada3;
    --muted-light: #ccd6d1;
    --label-color: #5a7a70;
    --slider-track: 10px;
    --thumb-size: 28px;
    --card-px: 16px;
  }
  @media (min-width: 600px) {
    :root { --card-px: 26px; }
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Roboto', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro', 'Hiragino Kaku Gothic Pro', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
    min-height: 100vh;
    padding: 16px 14px 36px;
    max-width: 900px;
    margin: 0 auto;
  }
  @media (min-width: 640px) {
    body { padding: 32px 20px 48px; }
  }

  /* ===== HEADER ===== */
  header { margin-bottom: clamp(16px, 4vw, 28px); }
  header h1 {
    font-size: clamp(1.2rem, 5vw, 1.7rem);
    font-weight: 700;
    color: var(--green);
    letter-spacing: 0.02em;
    margin-bottom: 5px;
  }
  header p {
    font-size: clamp(0.75rem, 2.3vw, 0.88rem);
    color: var(--muted);
  }

  /* ===== CARD ===== */
  .card {
    background: var(--card);
    border-radius: clamp(14px, 3vw, 22px);
    padding: 18px var(--card-px) 20px;
    box-shadow: 0 4px 28px rgba(74,140,111,0.09);
    margin-bottom: 12px;
  }
  @media (min-width: 600px) {
    .card { padding: 28px var(--card-px); margin-bottom: 18px; }
  }

  .card-label {
    font-size: clamp(0.65rem, 1.9vw, 0.78rem);
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--mint);
    margin-bottom: clamp(14px, 3vw, 20px);
  }

  /* ===== INPUT ROWS ===== */
  .input-rows { display: flex; flex-direction: column; gap: clamp(16px, 3.5vw, 22px); }

  /* Mobile-first: 1åˆ— â†’ 560pxä»¥ä¸Šã§2åˆ— */
  .irow {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
  }
  @media (min-width: 560px) {
    .irow {
      grid-template-columns: 200px 1fr;
      align-items: center;
      gap: 16px;
    }
  }

  .irow-label { display: flex; flex-direction: column; gap: 3px; }
  .irow-label .lname {
    font-size: clamp(0.88rem, 2.8vw, 1.05rem);
    font-weight: 600;
    color: var(--text);
    line-height: 1.3;
  }
  .irow-label .ldesc {
    font-size: clamp(0.65rem, 2vw, 0.75rem);
    color: var(--muted);
    line-height: 1.4;
  }

  .irow-right { display: flex; flex-direction: column; gap: 8px; }

  /* value row */
  .val-row { display: flex; align-items: baseline; gap: 6px; }
  .num-edit {
    font-size: clamp(1.5rem, 6vw, 2rem);
    font-weight: 700;
    color: var(--text);
    font-family: 'Roboto', sans-serif;
    border: none;
    border-bottom: 2.5px solid var(--mint);
    outline: none;
    background: transparent;
    width: 110px;
    -moz-appearance: textfield;
    padding: 0 3px 2px;
    transition: border-color .2s;
    line-height: 1.1;
  }
  .num-edit:focus { border-bottom-color: var(--green); }
  .num-edit::-webkit-outer-spin-button,
  .num-edit::-webkit-inner-spin-button { -webkit-appearance: none; }
  .val-unit {
    font-size: clamp(0.82rem, 2.5vw, 1rem);
    color: var(--muted);
    font-weight: 500;
  }

  /* DOB ã‚»ãƒ¬ã‚¯ãƒˆ */
  .dob-row { display: flex; align-items: baseline; gap: 6px; flex-wrap: wrap; }
  .dob-row select {
    font-size: clamp(1.5rem, 6vw, 2rem);
    font-weight: 700;
    color: var(--text);
    font-family: 'Roboto', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro', sans-serif;
    border: none;
    border-bottom: 2.5px solid var(--mint);
    background: transparent;
    outline: none;
    cursor: pointer;
    padding: 0 4px 2px;
    -webkit-appearance: none;
    appearance: none;
    transition: border-color .2s;
    line-height: 1.1;
    option { font-size: 0.85rem; font-weight: 400; }
  }
  .dob-row select:focus { border-bottom-color: var(--green); }
  .dob-unit {
    font-size: clamp(0.82rem, 2.5vw, 1rem);
    color: var(--muted);
    font-weight: 500;
  }
  .age-display {
    font-size: clamp(0.75rem, 2.3vw, 0.88rem);
    color: var(--label-color);
    font-weight: 500;
    margin-left: 4px;
    white-space: nowrap;
  }
  .age-display.warn { color: #e07a3a; font-weight: 600; margin-left: 0; }
  .eval-warn {
    font-size: clamp(0.62rem, 1.8vw, 0.7rem);
    color: #e07a3a;
    margin-top: 2px;
    display: none;
  }
  .eval-warn.show { display: block; }

  /* ===== SLIDER ===== */
  .slider-row {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
  }
  .pm-btn {
    width: clamp(30px, 8vw, 34px);
    height: clamp(30px, 8vw, 34px);
    border-radius: 50%;
    background: var(--green);
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: clamp(1.1rem, 3.5vw, 1.3rem);
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    line-height: 1;
    box-shadow: 0 2px 8px rgba(74,140,111,0.3);
    transition: background .15s, transform .1s;
    user-select: none;
  }
  .pm-btn:hover { background: #3a7a5f; }
  .pm-btn:active { transform: scale(0.92); }

  .range-wrap { flex: 1; min-width: 0; }

  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: var(--slider-track);
    background: linear-gradient(
      to right,
      var(--green) 0%, var(--green) var(--pct, 0%),
      var(--muted-light) var(--pct, 0%), var(--muted-light) 100%
    );
    border-radius: 99px;
    outline: none;
    cursor: pointer;
    display: block;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: var(--thumb-size);
    height: var(--thumb-size);
    border-radius: 50%;
    background: var(--green);
    border: 3px solid #fff;
    box-shadow: 0 2px 10px rgba(74,140,111,0.45);
    transition: transform .15s;
    cursor: grab;
  }
  input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.12); }
  input[type="range"]::-moz-range-thumb {
    width: var(--thumb-size);
    height: var(--thumb-size);
    border-radius: 50%;
    background: var(--green);
    border: 3px solid #fff;
    box-shadow: 0 2px 10px rgba(74,140,111,0.45);
    cursor: grab;
  }

  .irow-divider { border: none; border-top: 1.5px solid var(--bg); }

  /* ===== OPTIONAL SECTION ===== */
  .optional-section {
    border-top: 1.5px solid var(--muted-light);
    padding-top: clamp(14px, 3vw, 18px);
    display: flex;
    flex-direction: column;
    gap: clamp(14px, 3vw, 18px);
  }
  .optional-header { display: flex; align-items: center; gap: 10px; }
  /* ãƒ¢ãƒã‚¤ãƒ«ï¼šãƒãƒƒã‚¸ã®ä¸‹ã«èª¬æ˜æ–‡ */
  @media (max-width: 559px) {
    .optional-header { flex-direction: column; align-items: flex-start; gap: 6px; }
  }
  .optional-badge {
    font-size: clamp(0.6rem, 1.8vw, 0.68rem);
    font-weight: 600;
    letter-spacing: 0.06em;
    background: var(--mint);
    color: var(--green);
    border-radius: 99px;
    padding: 3px 10px;
    white-space: nowrap;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .optional-desc {
    font-size: clamp(0.7rem, 2.2vw, 0.78rem);
    color: var(--muted);
    line-height: 1.5;
  }
  /* ãƒ¢ãƒã‚¤ãƒ«ã¯ç¸¦ä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãŸã‚æ”¹è¡Œã‚¿ã‚°ã¯å¸¸ã«éè¡¨ç¤º */
  .br-sp { display: none; }

  /* ===== SUMMARY ===== */
  /* Mobile: 2åˆ—ã€480pxä»¥ä¸Š: 3åˆ— */
  .summary {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: clamp(14px, 3.5vw, 22px);
  }
  @media (min-width: 480px) {
    .summary { grid-template-columns: repeat(3, 1fr); gap: 12px; }
  }
  /* ãƒ¢ãƒã‚¤ãƒ«2åˆ—æ™‚ï¼š3ç•ªç›®ã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒ•ãƒ«ã‚¹ãƒ‘ãƒ³ */
  @media (max-width: 479px) {
    .sitem:last-child { grid-column: 1 / -1; }
  }

  .sitem {
    background: var(--bg);
    border-radius: clamp(10px, 2.5vw, 16px);
    padding: clamp(12px, 3vw, 20px) clamp(8px, 2vw, 14px) clamp(10px, 2.5vw, 18px);
    text-align: center;
  }
  .sitem .sl {
    font-size: clamp(0.72rem, 2.2vw, 1rem);
    color: var(--label-color);
    font-weight: 600;
    margin-bottom: clamp(6px, 1.8vw, 10px);
    line-height: 1.4;
  }
  .sitem .sv { font-family: 'Roboto', sans-serif; line-height: 1.1; }
  .sv-num {
    font-size: clamp(1.4rem, 5vw, 2rem);
    font-weight: 700;
    color: var(--green);
  }
  .sv-man {
    font-size: clamp(0.85rem, 2.8vw, 1.1rem);
    font-weight: 700;
    color: var(--green);
    margin-left: 3px;
  }
  .sitem .sv-sub {
    font-size: clamp(0.75rem, 2.3vw, 0.92rem);
    color: var(--label-color);
    font-weight: 600;
    margin-top: 8px;
  }

  .nisa-done-num {
    font-size: clamp(1.4rem, 5vw, 2rem);
    font-weight: 700;
    color: var(--green);
    font-family: 'Roboto', sans-serif;
  }
  .nisa-done-unit {
    font-size: clamp(0.75rem, 2.5vw, 0.95rem);
    font-weight: 700;
    color: var(--green);
    margin-left: 1px;
    margin-right: 2px;
    font-family: 'Roboto', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro', sans-serif;
    vertical-align: middle;
  }
  .nisa-done-detail {
    font-size: clamp(0.75rem, 2.3vw, 0.92rem);
    color: var(--label-color);
    font-weight: 600;
    margin-top: 8px;
  }

  /* ===== CHART ===== */
  .legend {
    display: flex;
    gap: clamp(10px, 3vw, 18px);
    flex-wrap: wrap;
    margin-bottom: clamp(8px, 2vw, 14px);
  }
  .li {
    display: flex;
    align-items: center;
    gap: 7px;
    font-size: clamp(0.72rem, 2.2vw, 0.84rem);
    color: var(--text);
  }
  .ld { width: 13px; height: 13px; border-radius: 3px; }
  .chart-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  canvas { display: block; cursor: default; }
  .note {
    font-size: clamp(0.6rem, 1.8vw, 0.72rem);
    color: var(--muted);
    text-align: right;
    margin-top: 8px;
  }

  /* ===== TOOLTIP ===== */
  #tooltip {
    position: fixed;
    background: #2c3a35;
    color: #fff;
    border-radius: 14px;
    padding: 13px 16px;
    font-size: clamp(0.72rem, 2.2vw, 0.84rem);
    pointer-events: none;
    opacity: 0;
    transition: opacity .15s;
    z-index: 200;
    min-width: 200px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.22);
    line-height: 1.9;
  }
  #tooltip.show { opacity: 1; }
  #tooltip .ty {
    font-size: clamp(0.82rem, 2.5vw, 0.96rem);
    font-weight: 700;
    color: var(--mint);
    margin-bottom: 3px;
  }
  #tooltip .ttotal {
    font-size: clamp(0.88rem, 2.8vw, 1.08rem);
    font-weight: 700;
    margin-bottom: 2px;
  }
  #tooltip .tr { display: flex; align-items: center; gap: 7px; }
  #tooltip .td { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
  #tooltip .tsep { border-top: 1px solid rgba(255,255,255,0.15); margin: 4px 0; }

  /* ===== DISCLAIMER ===== */
  .disclaimer {
    margin-top: 10px;
    padding: 12px 14px;
    background: rgba(255,255,255,0.6);
    border-radius: 14px;
    font-size: clamp(0.58rem, 1.8vw, 0.65rem);
    color: var(--muted);
    line-height: 1.7;
  }
  @media (min-width: 600px) {
    .disclaimer { padding: 14px 18px; }
  }
  .disclaimer p + p { margin-top: 5px; }
</style>
</head>
<body>

<header>
  <h1>ğŸŒ¿ æ–°NISAç©ç«‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
  <p>æ–°NISAç·æ  1,800ä¸‡å††ã‚’è€ƒæ…®ã—ãŸé•·æœŸé‹ç”¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</p>
</header>

<div class="card">
  <div class="card-label">å…¥åŠ›æ¡ä»¶</div>
  <div class="input-rows">

    <!-- ç”Ÿå¹´æœˆæ—¥ -->
    <div class="irow">
      <div class="irow-label">
        <span class="lname">ç”Ÿå¹´æœˆæ—¥</span>
        <span class="ldesc">å¹´ãƒ»æœˆã‚’é¸æŠ</span>
      </div>
      <div class="irow-right">
        <div class="dob-row">
          <select id="dobYear"></select><span class="dob-unit">å¹´</span>
          <select id="dobMonth"></select><span class="dob-unit">æœˆ</span>
          <span class="age-display" id="ageDisplay"></span>
        </div>
      </div>
    </div>

    <hr class="irow-divider">

    <!-- æ¯æœˆã®ç©ç«‹é¡ -->
    <div class="irow">
      <div class="irow-label">
        <span class="lname">æ¯æœˆã®ç©ç«‹é¡</span>
      </div>
      <div class="irow-right">
        <div class="val-row">
          <input class="num-edit" type="number" id="inMonthly" min="0" max="30" step="0.1" value="5">
          <span class="val-unit">ä¸‡å††</span>
        </div>
        <div class="slider-row">
          <button class="pm-btn" data-target="slMonthly" data-step="-0.1">ï¼</button>
          <div class="range-wrap"><input type="range" id="slMonthly" min="0" max="30" step="0.1" value="5"></div>
          <button class="pm-btn" data-target="slMonthly" data-step="0.1">ï¼‹</button>
        </div>
      </div>
    </div>

    <hr class="irow-divider">

    <!-- åˆ©å›ã‚Š -->
    <div class="irow">
      <div class="irow-label">
        <span class="lname">æƒ³å®šåˆ©å›ã‚Šï¼ˆå¹´ç‡ï¼‰</span>
      </div>
      <div class="irow-right">
        <div class="val-row">
          <input class="num-edit" type="number" id="inRate" min="0" max="10" step="0.1" value="5">
          <span class="val-unit">%</span>
        </div>
        <div class="slider-row">
          <button class="pm-btn" data-target="slRate" data-step="-0.1">ï¼</button>
          <div class="range-wrap"><input type="range" id="slRate" min="0" max="10" step="0.1" value="5"></div>
          <button class="pm-btn" data-target="slRate" data-step="0.1">ï¼‹</button>
        </div>
      </div>
    </div>

    <!-- ä»»æ„å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="optional-section">
      <div class="optional-header">
        <span class="optional-badge">ä»»æ„å…¥åŠ›</span>
        <span class="optional-desc">ã™ã§ã«æ–°NISAã§æŠ•è³‡ã—ã¦ã„ã‚‹æ–¹ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br class="br-sp">ã¾ã æŠ•è³‡ã—ã¦ã„ãªã„æ–¹ã¯ 0 ã®ã¾ã¾ã§OKã§ã™ã€‚</span>
      </div>

      <!-- æ–°NISAæŠ•è³‡ç´¯è¨ˆé¡ -->
      <div class="irow">
        <div class="irow-label">
          <span class="lname">æ–°NISAæŠ•è³‡ç´¯è¨ˆé¡</span>
          <span class="ldesc">ã“ã‚Œã¾ã§ã«æ–°NISAã¸æŠ•è³‡ã—ãŸåˆè¨ˆé¡</span>
        </div>
        <div class="irow-right">
          <div class="val-row">
            <input class="num-edit" type="number" id="inContrib" min="0" max="1800" step="1" value="0">
            <span class="val-unit">ä¸‡å††</span>
          </div>
          <div class="slider-row">
            <button class="pm-btn" data-target="slContrib" data-step="-1">ï¼</button>
            <div class="range-wrap"><input type="range" id="slContrib" min="0" max="1800" step="1" value="0"></div>
            <button class="pm-btn" data-target="slContrib" data-step="1">ï¼‹</button>
          </div>
        </div>
      </div>

      <!-- ç¾åœ¨ã®è©•ä¾¡é¡ -->
      <div class="irow">
        <div class="irow-label">
          <span class="lname">ç¾åœ¨ã®è©•ä¾¡é¡</span>
          <span class="ldesc">ç¾åœ¨ã®æ–°NISAã®æ™‚ä¾¡è©•ä¾¡é¡</span>
        </div>
        <div class="irow-right">
          <div class="val-row">
            <input class="num-edit" type="number" id="inEval" min="0" max="9999" step="1" value="0">
            <span class="val-unit">ä¸‡å††</span>
          </div>
          <div class="slider-row">
            <button class="pm-btn" data-target="slEval" data-step="-10">ï¼</button>
            <div class="range-wrap"><input type="range" id="slEval" min="0" max="9999" step="1" value="0"></div>
            <button class="pm-btn" data-target="slEval" data-step="10">ï¼‹</button>
          </div>
          <div id="evalWarn" class="eval-warn">âš  è©•ä¾¡é¡ãŒæŠ•è³‡ç´¯è¨ˆé¡ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™ï¼ˆå«ã¿æã®çŠ¶æ…‹ï¼‰</div>
        </div>
      </div>

    </div><!-- /optional-section -->
  </div>
</div>

<div class="card" id="resultCard">
  <div class="card-label">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</div>
  <div class="summary" id="summary"></div>
  <div class="legend">
    <div class="li"><div class="ld" style="background:#a8d5ba"></div>å…ƒæœ¬</div>
    <div class="li"><div class="ld" style="background:#4a8c6f"></div>é‹ç”¨åç›Š</div>
  </div>
  <div class="chart-wrap">
    <canvas id="chart"></canvas>
  </div>
  <div class="note">â€» æ–°NISAæ ï¼ˆ1,800ä¸‡å††ï¼‰åˆ°é”å¾Œã¯æ–°è¦ç©ç«‹åœæ­¢ãƒ»é‹ç”¨ã®ã¿ç¶™ç¶š</div>
</div>

<div class="disclaimer">
  <p>ã€å…è²¬äº‹é …ã€‘æœ¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯ã€ä¸€å®šã®å‰ææ¡ä»¶ã®ã‚‚ã¨ã§è©¦ç®—ã—ãŸå‚è€ƒå€¤ã§ã‚ã‚Šã€å°†æ¥ã®é‹ç”¨æˆæœã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å®Ÿéš›ã®æŠ•è³‡ã«ãŠã„ã¦ã¯ã€å…ƒæœ¬å‰²ã‚Œã®ãƒªã‚¹ã‚¯ã‚’å«ã‚€æ§˜ã€…ãªãƒªã‚¹ã‚¯ãŒå­˜åœ¨ã—ã¾ã™ã€‚</p>
  <p>è¡¨ç¤ºã•ã‚Œã‚‹æ•°å€¤ã¯ç¨é‡‘ãƒ»æ‰‹æ•°æ–™ç­‰ã‚’è€ƒæ…®ã—ã¦ã„ã¾ã›ã‚“ã€‚æ–°NISAã®åˆ¶åº¦å†…å®¹ã¯ä»Šå¾Œå¤‰æ›´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ã«ãŠã„ã¦è¡Œã£ã¦ãã ã•ã„ã€‚å…·ä½“çš„ãªæŠ•è³‡ã«ã¤ã„ã¦ã¯ã€é‡‘èæ©Ÿé–¢ã‚„å°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„ã€‚</p>
  <p>æœ¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®æƒ…å ±ã®æ­£ç¢ºæ€§ãƒ»å®Œå…¨æ€§ã«ã¤ã„ã¦ã€ä¸€åˆ‡ã®ä¿è¨¼ã‚’è¡Œã„ã¾ã›ã‚“ã€‚</p>
</div>

<div id="tooltip"></div>

<script>
const NISA_MAX = 18_000_000;
let bars = [];
let hoveredIdx = -1;
let nisaFullInfo = null;

function fmtYenParts(n) {
  n = Math.round(n);
  if (n >= 100_000_000) {
    const oku = Math.floor(n / 100_000_000);
    const man = Math.round((n % 100_000_000) / 10_000);
    if (man === 0) return { num: oku.toLocaleString('ja-JP'), unit: 'å„„å††' };
    return { num: oku.toLocaleString('ja-JP') + 'å„„' + man.toLocaleString('ja-JP'), unit: 'ä¸‡å††' };
  }
  return { num: Math.round(n / 10_000).toLocaleString('ja-JP'), unit: 'ä¸‡å††' };
}
function fmtYen(n) { const { num, unit } = fmtYenParts(n); return num + unit; }
function fmtAxisMan(n) {
  if (n >= 100_000_000) return (n / 100_000_000).toFixed(1).replace(/\.0$/, '') + 'å„„';
  return Math.round(n / 10_000).toLocaleString('ja-JP') + 'ä¸‡';
}
function clamp(v, min, max) { return Math.min(max, Math.max(min, v)); }

// ---- DOB ----
const now = new Date();
const currentYear  = now.getFullYear();
const currentMonth = now.getMonth() + 1;

const dobYearSel  = document.getElementById('dobYear');
const dobMonthSel = document.getElementById('dobMonth');

// 65æ­³æœªæº€ã«ãªã‚Œã‚‹å¹´ã®ä¸‹é™ï¼ˆãã®å¹´ç”Ÿã¾ã‚Œã§ã‚‚æœ€ä½1ãƒ¶æœˆã¯64æ­³ä»¥ä¸‹ã«ãªã‚Œã‚‹ï¼‰
const minBirthYear = currentMonth < 12 ? currentYear - 65 : currentYear - 64;
for (let y = currentYear - 18; y >= minBirthYear; y--) {
  const o = document.createElement('option');
  o.value = y; o.textContent = y;
  dobYearSel.appendChild(o);
}
dobYearSel.value = currentYear - 40;

for (let m = 1; m <= 12; m++) {
  const o = document.createElement('option');
  o.value = m; o.textContent = m;
  dobMonthSel.appendChild(o);
}
dobMonthSel.value = currentMonth;

// é¸æŠä¸­ã®å¹´ã«å¯¾ã—ã¦65æ­³ä»¥ä¸Šã«ãªã‚‹æœˆã‚’disabledã«ã™ã‚‹
function updateMonthOptions() {
  const y = parseInt(dobYearSel.value);
  Array.from(dobMonthSel.options).forEach(o => {
    const m = parseInt(o.value);
    const ageMonths = (currentYear - y) * 12 + (currentMonth - m);
    o.disabled = Math.floor(Math.max(0, ageMonths) / 12) >= 65;
  });
  // ç¾åœ¨é¸æŠä¸­ã®æœˆãŒç„¡åŠ¹ã«ãªã£ã¦ã„ãŸã‚‰ã€æœ€åˆã®æœ‰åŠ¹ãªæœˆã¸ç§»å‹•
  const curOpt = Array.from(dobMonthSel.options).find(o => parseInt(o.value) === parseInt(dobMonthSel.value));
  if (curOpt && curOpt.disabled) {
    const first = Array.from(dobMonthSel.options).find(o => !o.disabled);
    if (first) dobMonthSel.value = first.value;
  }
}

function getAgeFromDOB() {
  const by = parseInt(dobYearSel.value);
  const bm = parseInt(dobMonthSel.value);
  let ageMonths = (currentYear - by) * 12 + (currentMonth - bm);
  if (ageMonths < 0) ageMonths = 0;
  const rawAge = Math.floor(ageMonths / 12);
  return { ageYears: clamp(rawAge, 18, 64), ageMon: ageMonths % 12, rawAge };
}

function updateAgeDisplay() {
  const { ageYears, ageMon } = getAgeFromDOB();
  const el = document.getElementById('ageDisplay');
  const rc = document.getElementById('resultCard');
  el.textContent = `ï¼ˆç¾åœ¨ ${ageYears}æ­³${ageMon > 0 ? ageMon + 'ãƒ¶æœˆ' : ''}ï¼‰`;
  el.classList.remove('warn');
  rc.style.display = '';
}

dobYearSel.addEventListener('change',  () => { updateMonthOptions(); updateAgeDisplay(); simulate(); });
dobMonthSel.addEventListener('change', () => { updateAgeDisplay(); simulate(); });
updateMonthOptions();
updateAgeDisplay();

// ---- Slider sync ----
function updateSliderBg(sl) {
  const pct = clamp(((parseFloat(sl.value) - parseFloat(sl.min)) / (parseFloat(sl.max) - parseFloat(sl.min))) * 100, 0, 100);
  sl.style.setProperty('--pct', pct + '%');
}

function linkInputs(numId, slId, slMin, slMax, step) {
  const num = document.getElementById(numId);
  const sl  = document.getElementById(slId);
  num.addEventListener('input', () => {
    let v = parseFloat(num.value);
    if (isNaN(v)) { simulate(); return; }
    sl.value = clamp(v, slMin, slMax);
    updateSliderBg(sl); simulate();
  });
  sl.addEventListener('input', () => {
    num.value = parseFloat(sl.value).toFixed(step < 1 ? 1 : 0);
    updateSliderBg(sl); simulate();
  });
  updateSliderBg(sl);
}

linkInputs('inContrib', 'slContrib', 0, 1800, 1);
linkInputs('inEval',    'slEval',    0, 9999, 1);
linkInputs('inMonthly', 'slMonthly', 0,   30, 0.1);
linkInputs('inRate',    'slRate',    0,   10, 0.1);

const numMap = { slContrib:'inContrib', slEval:'inEval', slMonthly:'inMonthly', slRate:'inRate' };

document.querySelectorAll('.pm-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const sl   = document.getElementById(btn.dataset.target);
    const step = parseFloat(btn.dataset.step);
    const next = clamp(parseFloat((parseFloat(sl.value) + step).toFixed(10)), parseFloat(sl.min), parseFloat(sl.max));
    sl.value = next;
    updateSliderBg(sl);
    const numEl = document.getElementById(numMap[sl.id]);
    if (numEl) numEl.value = next.toFixed(Math.abs(step) < 1 ? 1 : 0);
    simulate();
  });
});

// ---- Eval warning ----
function checkEvalWarn() {
  const contrib = parseFloat(document.getElementById('inContrib').value) || 0;
  const evalV   = parseFloat(document.getElementById('inEval').value)    || 0;
  const warn = document.getElementById('evalWarn');
  if (evalV > 0 && contrib > 0 && evalV < contrib) {
    warn.classList.add('show');
  } else {
    warn.classList.remove('show');
  }
}

// ---- Simulate ----
function simulate() {
  const { ageYears: age, ageMon: startMon } = getAgeFromDOB();
  const contrib = (parseFloat(document.getElementById('inContrib').value) || 0) * 10_000;
  const evalAmt = (parseFloat(document.getElementById('inEval').value)    || 0) * 10_000;
  const monthly = (parseFloat(document.getElementById('inMonthly').value) || 0) * 10_000;
  const annualR = (parseFloat(document.getElementById('inRate').value)    || 0) / 100;

  const ageInMonths = age * 12 + startMon;
  const monthsLeft  = Math.max(12, 65 * 12 - ageInMonths);
  const mr = annualR / 12;

  let balance     = evalAmt > 0 ? evalAmt : contrib;
  let contributed = contrib;
  let principal   = contrib;
  nisaFullInfo    = null;

  const data = [];
  for (let absMonth = 1; absMonth <= monthsLeft; absMonth++) {
    balance *= (1 + mr);
    if (contributed < NISA_MAX && monthly > 0) {
      const add = Math.min(monthly, NISA_MAX - contributed);
      balance += add; principal += add; contributed += add;
      if (contributed >= NISA_MAX && nisaFullInfo === null) {
        const tam = ageInMonths + absMonth;
        nisaFullInfo = {
          simYear:  Math.floor((absMonth - 1) / 12) + 1,
          simMonth: ((absMonth - 1) % 12) + 1,
          age: Math.floor(tam / 12), ageMon: tam % 12
        };
      }
    }
    if (absMonth % 12 === 0) {
      const tam = ageInMonths + absMonth;
      data.push({
        year: absMonth / 12,
        age: Math.floor(tam / 12),
        absEndMonth: absMonth,
        principal, gain: balance - principal,
        total: balance,
        nisaLeft: Math.max(0, NISA_MAX - contributed),
      });
    }
  }

  checkEvalWarn();
  bars = data;
  hoveredIdx = -1;
  renderSummary(data, ageInMonths, monthsLeft, contrib, monthly);
  renderChart(data);
}

// ---- Summary ----
function renderSummary(data, ageInMonths, monthsLeft, contrib, monthly) {
  if (!data.length) return;
  const last      = data[data.length - 1];
  const yearsLeft = Math.round(monthsLeft / 12);

  function svHtml(n) {
    const { num, unit } = fmtYenParts(n);
    return `<span class="sv-num">${num}</span><span class="sv-man">${unit}</span>`;
  }

  let nisaCell;
  if (nisaFullInfo) {
    const { simYear, simMonth, age: fAge, ageMon: fAgeM } = nisaFullInfo;
    nisaCell = `
      <div>
        <span class="nisa-done-num">${simYear}</span><span class="nisa-done-unit">å¹´</span><span class="nisa-done-num">${simMonth}</span><span class="nisa-done-unit">ãƒ¶æœˆç›®</span>
      </div>
      <div class="nisa-done-detail">${fAge}æ­³${fAgeM}ãƒ¶æœˆ</div>
    `;
  } else {
    const futureContrib = Math.min(monthly * monthsLeft, Math.max(0, NISA_MAX - contrib));
    const totalIn = contrib + futureContrib;
    const { num, unit } = fmtYenParts(totalIn);
    nisaCell = `
      <div><span class="nisa-done-num" style="font-size:1.5rem">æœªåˆ°é”</span></div>
      <div class="nisa-done-detail">å…¥é‡‘åˆè¨ˆ <span style="color:var(--green);font-weight:700">${num}${unit}</span></div>
    `;
  }

  document.getElementById('summary').innerHTML = `
    <div class="sitem">
      <div class="sl">65æ­³æ™‚ã®è³‡ç”£ï¼ˆ${yearsLeft}å¹´å¾Œï¼‰</div>
      <div class="sv">${svHtml(last.total)}</div>
    </div>
    <div class="sitem">
      <div class="sl">ã†ã¡é‹ç”¨åç›Š</div>
      <div class="sv">${svHtml(last.gain)}</div>
    </div>
    <div class="sitem">
      <div class="sl">æ–°NISAæ ä½¿ã„åˆ‡ã‚Š</div>
      <div class="sv">${nisaCell}</div>
    </div>
  `;
}

// ---- Chart ----
function rRect(ctx, x, y, w, h, r) {
  if (h <= 0 || w <= 0) return;
  if (typeof r === 'number') r = [r,r,r,r];
  ctx.beginPath();
  ctx.moveTo(x+r[0], y);
  ctx.lineTo(x+w-r[1], y); ctx.quadraticCurveTo(x+w, y, x+w, y+r[1]);
  ctx.lineTo(x+w, y+h-r[2]); ctx.quadraticCurveTo(x+w, y+h, x+w-r[2], y+h);
  ctx.lineTo(x+r[3], y+h); ctx.quadraticCurveTo(x, y+h, x, y+h-r[3]);
  ctx.lineTo(x, y+r[0]); ctx.quadraticCurveTo(x, y, x+r[0], y);
  ctx.closePath(); ctx.fill();
}

function renderChart(data) {
  const isMobile   = window.innerWidth < 560;
  const MOBILE_MAX = 25; // ã“ã‚Œã‚’è¶…ãˆãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  const hiIdx  = hoveredIdx;
  const canvas = document.getElementById('chart');
  const dpr    = window.devicePixelRatio || 1;
  const containerW = canvas.parentElement.clientWidth;
  const n      = data.length;

  /* ãƒ¢ãƒã‚¤ãƒ«æ™‚ï¼šå·¦ãƒ©ãƒ™ãƒ«ãªã— â†’ PAD.l ã‚’æœ€å°ã« */
  const PAD = {
    t: 14,
    r: isMobile ? 6 : 14,
    b: isMobile ? 34 : 42,
    l: isMobile ? 6 : 64,
  };

  /* ãƒ¢ãƒã‚¤ãƒ«ã§25æœ¬è¶…ã®å ´åˆã€25æœ¬åˆ†ã®å¯†åº¦ã‚’ä¿ã¡ãªãŒã‚‰canvasã‚’æ‹¡å¹… */
  let cW;
  if (isMobile && n > MOBILE_MAX) {
    const slotW = (containerW - PAD.l - PAD.r) / MOBILE_MAX;
    cW = Math.ceil(PAD.l + PAD.r + slotW * n);
  } else {
    cW = containerW;
  }

  const plotW = cW - PAD.l - PAD.r;
  const BAR   = Math.max(3, plotW / n - Math.max(1, Math.min(4, plotW / n * 0.28)));
  const GAP   = Math.max(1, plotW / n - BAR);
  const W     = cW;
  const H     = isMobile ? 220 : 300;
  const pH    = H - PAD.t - PAD.b;

  canvas.width  = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';

  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  const maxVal = Math.max(...data.map(d => d.total), 1);

  /* ã‚°ãƒªãƒƒãƒ‰ç·š ï¼‹ Yè»¸ãƒ©ãƒ™ãƒ«ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®ã¿ï¼‰ */
  for (let i = 0; i <= 4; i++) {
    const y = PAD.t + pH - pH * i / 4;
    ctx.strokeStyle = '#deeee8'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(PAD.l, y); ctx.lineTo(W - PAD.r, y); ctx.stroke();
    if (!isMobile) {
      ctx.fillStyle = '#7a9a90';
      ctx.font = '500 10px Roboto, sans-serif';
      ctx.textAlign = 'right';
      ctx.fillText(fmtAxisMan(maxVal * i / 4), PAD.l - 6, y + 3.5);
    }
  }

  /* Xè»¸ãƒ©ãƒ™ãƒ«ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼šãƒ¢ãƒã‚¤ãƒ«ã¯10å¹´ã”ã¨ */
  const labelStep = isMobile ? 10 : 5;

  bars = data.map((d, i) => {
    const x        = PAD.l + i * (BAR + GAP);
    const baseY    = PAD.t + pH;
    const totalH   = (d.total     / maxVal) * pH;
    const principH = (d.principal / maxVal) * pH;
    const gainH    = totalH - principH;
    const isHov    = i === hiIdx;

    if (isHov) {
      ctx.fillStyle = 'rgba(74,140,111,0.09)';
      ctx.beginPath();
      if (ctx.roundRect) ctx.roundRect(x - 3, PAD.t, BAR + 6, pH, 5);
      else ctx.rect(x - 3, PAD.t, BAR + 6, pH);
      ctx.fill();
    }

    ctx.fillStyle = isHov ? '#7ec9a0' : '#a8d5ba';
    rRect(ctx, x, baseY - principH, BAR, principH, [0, 0, 4, 4]);
    if (gainH > 0.5) {
      ctx.fillStyle = isHov ? '#3a7a5f' : '#4a8c6f';
      rRect(ctx, x, baseY - totalH, BAR, gainH, [4, 4, 0, 0]);
    }

    if (d.year === 1 || d.year % labelStep === 0) {
      ctx.fillStyle = '#7a9a90';
      ctx.font = isMobile ? '500 8.5px Roboto, sans-serif' : '500 9.5px Roboto, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(d.age + 'æ­³', x + BAR / 2, H - PAD.b + 13);
      ctx.strokeStyle = '#ccd6d1'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(x + BAR/2, baseY); ctx.lineTo(x + BAR/2, baseY + 4); ctx.stroke();
    }

    return { ...d, _x: x, _w: BAR };
  });
}

// ---- Tooltip ----
const tip = document.getElementById('tooltip');

function onPointer(e) {
  const canvas = document.getElementById('chart');
  const rect   = canvas.getBoundingClientRect();
  const cx = e.touches ? e.touches[0].clientX : e.clientX;
  const cy = e.touches ? e.touches[0].clientY : e.clientY;
  const lx = (cx - rect.left) * (parseFloat(canvas.style.width) / rect.width);

  const idx = bars.findIndex(b => lx >= b._x - 3 && lx <= b._x + b._w + 3);
  if (idx < 0) {
    if (hoveredIdx !== -1) { hoveredIdx = -1; renderChart(bars); }
    tip.classList.remove('show'); return;
  }
  if (hoveredIdx !== idx) { hoveredIdx = idx; renderChart(bars); }

  const d = bars[idx];
  const { ageYears, ageMon: startMon } = getAgeFromDOB();
  const tam        = ageYears * 12 + startMon + d.absEndMonth;
  const dispAge    = Math.floor(tam / 12);
  const dispAgeMon = tam % 12;

  tip.innerHTML = `
    <div class="ty">${d.year}å¹´ç›®ï¼ˆ${dispAge}æ­³${dispAgeMon}ãƒ¶æœˆï¼‰</div>
    <div class="ttotal">åˆè¨ˆï¼š${fmtYen(d.total)}</div>
    <div class="tsep"></div>
    <div class="tr"><div class="td" style="background:#a8d5ba"></div>å…ƒæœ¬ï¼š${fmtYen(d.principal)}</div>
    <div class="tr"><div class="td" style="background:#4a8c6f"></div>é‹ç”¨åç›Šï¼š${fmtYen(d.gain)}</div>
    <div class="tsep"></div>
    <div class="tr"><div class="td" style="background:#ccd6d1"></div>æ–°NISAæ®‹æ ï¼š${fmtYen(d.nisaLeft)}</div>
  `;

  const TW = 220, TH = 182;
  let tx = cx + 16, ty = cy - 20;
  if (tx + TW > window.innerWidth)  tx = cx - TW - 16;
  if (tx < 4) tx = 4;
  if (ty + TH > window.innerHeight) ty = cy - TH - 10;
  if (ty < 4) ty = 4;
  tip.style.left = tx + 'px'; tip.style.top = ty + 'px';
  tip.classList.add('show');
}

function hideTip() {
  if (hoveredIdx !== -1) { hoveredIdx = -1; renderChart(bars); }
  tip.classList.remove('show');
}

const cvs = document.getElementById('chart');
cvs.addEventListener('mousemove',  onPointer);
cvs.addEventListener('mouseleave', hideTip);

// ã‚¿ãƒƒãƒé–‹å§‹åº§æ¨™ã‚’è¨˜éŒ²ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ–¹å‘ã‚’åˆ¤å®šã™ã‚‹
let _touchStartX = 0, _touchStartY = 0;
cvs.addEventListener('touchstart', e => {
  _touchStartX = e.touches[0].clientX;
  _touchStartY = e.touches[0].clientY;
}, { passive: true });

cvs.addEventListener('touchmove', e => {
  const dx = Math.abs(e.touches[0].clientX - _touchStartX);
  const dy = Math.abs(e.touches[0].clientY - _touchStartY);
  // æ¨ªç§»å‹•ãŒç¸¦ç§»å‹•ã‚ˆã‚Šå¤§ããã€5pxä»¥ä¸Šãªã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆï¼ˆpreventDefault ã—ãªã„ï¼‰
  if (dx > dy && dx > 5) { hideTip(); return; }
  e.preventDefault();
  onPointer(e);
}, { passive: false });

cvs.addEventListener('touchend', hideTip);
window.addEventListener('resize', () => { if (bars.length) renderChart(bars); });

simulate();
</script>
</body>
</html>
